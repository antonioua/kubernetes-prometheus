apiVersion: v1
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: prometheus-rules
  namespace: monitoring
data:
  cpu-usage.rules.yaml: |
    # https://github.com/prometheus/prometheus/blob/master/docs/configuration/alerting_rules.md
    # Example alert rule
    groups:
    - name: example.rules
      rules:
      - record: job:request_duration_seconds:histogram_quantile99
        expr: histogram_quantile(0.99, sum(rate(request_duration_seconds_bucket[1m]))
          BY (le, job))
      - alert: FrontendRequestLatency
        expr: job:request_duration_seconds:histogram_quantile99{job="frontend"} > 0.1
        for: 5m
        annotations:
          summary: High frontend request latency

    # Alert for any instance that is unreachable for >5 minutes.
    - alert: InstanceDown
      expr: up == 0
      for: 5m
      labels:
        severity: page
      annotations:
        summary: "Instance {{ $labels.instance }} down"
        description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes."

    # Alert for any instance that has a median request latency >1s.
    - alert: APIHighRequestLatency
      expr: api_http_request_latencies_second{quantile="0.5"} > 1
      for: 10m
      annotations:
        summary: "High request latency on {{ $labels.instance }}"
        description: "{{ $labels.instance }} has a median request latency above 1s (current value: {{ $value }}s)"

    #cpu-usage-node.rules: |
    #    ALERT: NodeCPUUtilizationLow
    #      IF (instance:node_cpu:rate:sum * 100) < 30
    #      FOR 15m
    #      LABELS {
    #        severity="page"
    #      }
    #      ANNOTATIONS {
    #        SUMMARY = "{{$labels.instance}}: High CPU usage detected."
    #        DESCRIPTION = "CPU utilization has been lower than 30% for last 15 minutes (current value is {{$value}})"
    #
    #  cpu-usage.rules: |
    #    ALERT NodeCPUUsage
    #      IF (100 - (avg by (instance) (irate(node_cpu{name="node-exporter",mode="idle"}[5m])) * 100)) > 75
    #      FOR 2m
    #      LABELS {
    #        severity="page"
    #      }
    #      ANNOTATIONS {
    #        SUMMARY = "{{$labels.instance}}: High CPU usage detected.",
    #        DESCRIPTION = "{{$labels.instance}}: CPU usage is above 75% (current value is: {{ $value }})"
    #      }
    #  mem-usage.rules: |
    #    ALERT NodeMemoryUsage
    #      IF (((node_memory_MemTotal-node_memory_MemFree-node_memory_Cached)/(node_memory_MemTotal)*100)) > 75
    #      FOR 2m
    #      LABELS {
    #        severity="page"
    #      }
    #      ANNOTATIONS {
    #        SUMMARY = "{{$labels.instance}}: High memory usage detected",
    #        DESCRIPTION = "{{$labels.instance}}: Memory usage is above 75% (current value is: {{ $value }})"
    #      }
    #  cpu-usage-node.rules: |
    #    ALERT: NodeCPUUtilizationLow
    #      IF (instance:node_cpu:rate:sum * 100) < 30
    #      FOR 15m
    #      LABELS {
    #        severity="page"
    #      }
    #      ANNOTATIONS {
    #        SUMMARY = "{{$labels.instance}}: High CPU usage detected."
    #        DESCRIPTION = "CPU utilization has been lower than 30% for last 15 minutes (current value is {{$value}})"
